---
import Base from "@layouts/Base.astro";
import { getAllCategories, getCategory, url } from "@lib/data";
import { stripMarkup } from "@lib/markup";
import { prepareFields } from "@lib/fields";
import FieldRenderer from "@components/FieldRenderer.astro";

export function getStaticPaths() {
  const paths: Array<{
    params: { category: string; entry: string };
    props: { displayName: string };
  }> = [];
  for (const cat of getAllCategories()) {
    const catFile = getCategory(cat.name);
    if (!catFile) continue;
    for (const typeId of Object.keys(catFile.entries)) {
      paths.push({
        params: { category: cat.name, entry: typeId },
        props: { displayName: cat.displayName },
      });
    }
  }
  return paths;
}

const { category, entry: typeId } = Astro.params;
const { displayName } = Astro.props;
const catFile = getCategory(category);
const entryData = catFile?.entries[typeId];
if (!entryData) return Astro.redirect("/");

const fields = prepareFields(entryData as Record<string, unknown>);
const nameField = fields.find((f) => f.key === "name");
const title = nameField ? stripMarkup(String(nameField.value)) : typeId;
---

<Base title={`${title} - ${displayName}`}>
  <nav class="text-sm text-stone-500 mb-4">
    <a href={url("/")} class="hover:text-stone-700">Home</a>
    <span class="mx-1">/</span>
    <a href={url(`/${category}/`)} class="hover:text-stone-700">{displayName}</a>
    <span class="mx-1">/</span>
    <span>{title}</span>
  </nav>

  <h1 class="text-3xl font-bold mb-1">{title}</h1>
  <p class="text-xs text-stone-400 font-mono mb-6">{typeId}</p>

  <div class="space-y-5">
    {
      fields
        .filter((f) => f.key !== "name")
        .map((field) => (
          <div>
            <h2 class="text-xs font-semibold text-stone-500 uppercase tracking-wide mb-1">
              {field.displayName}
            </h2>
            <FieldRenderer field={field} />
          </div>
        ))
    }
  </div>
</Base>
